<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maddybot - Your AI Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
</head>
<body>
    <div class="chatbox">

        <!-- Header -->
        <div class="chat-header">
            <div class="header-left">
                <div class="avatar">M</div>
                <div class="header-info">
                    <h1>Maddybot</h1>
                    <span class="status">
                        <span class="status-dot"></span>
                        Online
                    </span>
                </div>
            </div>

            <button class="clear-btn" onclick="clearChat()" title="Clear chat">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chatlog">
            <div class="welcome-message">
                <div class="welcome-avatar">ðŸ‘‹</div>
                <h2>Hi! I'm Maddy</h2>
                <p>Your friendly AI assistant. Ask me anything!</p>
            </div>
        </div>

        <!-- Input -->
        <div class="input-area">
            <input id="userinput"
                   type="text"
                   placeholder="Type your message here..."
                   onkeydown="if(event.key === 'Enter') window.sendMessage();"
                   autocomplete="off">

            <button id="sendBtn" onclick="window.sendMessage()">
                <svg width="20" height="20" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
            </button>
        </div>
    </div>


<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>

// Markdown config
marked.setOptions({
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    },
    breaks: true
});

let conversationHistory = [];


/* =========================
   TIMESTAMP FIX (IMPORTANT)
========================= */

// Local timestamp for user messages
function getTimestamp() {
    return new Date().toLocaleTimeString(navigator.language, {
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Convert backend UTC -> local time
function formatTimestamp(utcString) {

    if (!utcString) return getTimestamp();

    const date = new Date(utcString);

    return date.toLocaleTimeString(navigator.language, {
        hour: '2-digit',
        minute: '2-digit'
    });
}


/* =========================
   STORAGE
========================= */

function saveHistory() {
    localStorage.setItem('maddybot_history', JSON.stringify(conversationHistory));
}

function loadHistory() {

    const saved = localStorage.getItem('maddybot_history');

    if (!saved) return;

    try {

        conversationHistory = JSON.parse(saved);

        const chatlog = document.getElementById("chatlog");

        if (conversationHistory.length > 0) {

            chatlog.innerHTML = '';

            conversationHistory.forEach(msg => {
                addMessageToUI(msg.role, msg.content, msg.timestamp);
            });
        }

    } catch {
        conversationHistory = [];
    }
}


/* =========================
   UI
========================= */

function escapeHTML(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function addMessageToUI(role, content, timestamp = null) {

    const chatlog = document.getElementById("chatlog");

    const time = timestamp
        ? formatTimestamp(timestamp)
        : getTimestamp();

    const welcome = chatlog.querySelector('.welcome-message');
    if (welcome) welcome.remove();

    const messageDiv = document.createElement('div');
    messageDiv.className = role === 'user' ? 'user' : 'Maddy';

    if (role === 'user') {

        messageDiv.innerHTML = `
            <div class="message-content">${escapeHTML(content)}</div>
            <span class="timestamp">${time}</span>
        `;

    } else {

        messageDiv.innerHTML = `
            <div class="message-header">
                <span class="bot-name">Maddy</span>
            </div>
            <div class="message-content">${marked.parse(content)}</div>
            <span class="timestamp">${time}</span>
        `;

        setTimeout(() => addCopyButtons(messageDiv), 0);
    }

    chatlog.appendChild(messageDiv);
    chatlog.scrollTop = chatlog.scrollHeight;
}


function addCopyButtons(container) {

    container.querySelectorAll('pre').forEach(pre => {

        if (pre.querySelector('.copy-btn')) return;

        const btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.innerHTML = 'ðŸ“‹ Copy';

        btn.onclick = async () => {

            const code = pre.querySelector('code')?.textContent || pre.textContent;

            await navigator.clipboard.writeText(code);

            btn.innerHTML = 'âœ“ Copied!';

            setTimeout(() => btn.innerHTML = 'ðŸ“‹ Copy', 2000);
        };

        pre.style.position = 'relative';
        pre.appendChild(btn);
    });
}


/* =========================
   SEND MESSAGE
========================= */

window.sendMessage = async function() {

    const input = document.getElementById("userinput");
    const sendBtn = document.getElementById("sendBtn");

    const message = input.value.trim();
    if (!message) return;

    input.disabled = true;
    sendBtn.disabled = true;

    const userTimestamp = new Date().toISOString();

    addMessageToUI('user', message, userTimestamp);

    conversationHistory.push({
        role: 'user',
        content: message,
        timestamp: userTimestamp
    });

    saveHistory();
    input.value = "";

    const chatlog = document.getElementById("chatlog");

    const typingDiv = document.createElement("div");
    typingDiv.className = "Maddy typing";
    typingDiv.innerHTML = `
        <div class="typing-indicator">
            <span></span><span></span><span></span>
        </div>
        <span class="typing-text">Maddy is thinking...</span>
    `;

    chatlog.appendChild(typingDiv);
    chatlog.scrollTop = chatlog.scrollHeight;

    try {

        const res = await fetch("/grok", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                prompt: message,
                history: conversationHistory.slice(0, -1)
            })
        });

        const data = await res.json();

        typingDiv.remove();

        const replyText = data.reply || "No response";

        addMessageToUI('assistant', replyText, data.timestamp);

        conversationHistory.push({
            role: 'assistant',
            content: replyText,
            timestamp: data.timestamp
        });

        saveHistory();

    } catch (err) {

        typingDiv.remove();

        addMessageToUI('assistant', `Error: ${err.message}`);

    } finally {

        input.disabled = false;
        sendBtn.disabled = false;
        input.focus();
    }
}


/* =========================
   CLEAR CHAT
========================= */

function clearChat() {

    if (!confirm('Clear all chat history?')) return;

    conversationHistory = [];
    localStorage.removeItem('maddybot_history');

    document.getElementById("chatlog").innerHTML = `
        <div class="welcome-message">
            <div class="welcome-avatar">ðŸ‘‹</div>
            <h2>Hi! I'm Maddy</h2>
            <p>Your friendly AI assistant. Ask me anything!</p>
        </div>
    `;
}


/* =========================
   INIT
========================= */

document.addEventListener('DOMContentLoaded', loadHistory);

</script>

</body>
</html>