<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maddybot - Your AI Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
</head>
<body>
    <div class="chatbox">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-left">
                <div class="avatar">M</div>
                <div class="header-info">
                    <h1>Maddybot</h1>
                    <span class="status">
                        <span class="status-dot"></span>
                        Online
                    </span>
                </div>
            </div>
            <button class="clear-btn" onclick="clearChat()" title="Clear chat">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chatlog">
            <div class="welcome-message">
                <div class="welcome-avatar">ðŸ‘‹</div>
                <h2>Hi! I'm Maddy</h2>
                <p>Your friendly AI assistant. Ask me anything!</p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <input id="userinput" type="text" placeholder="Type your message here..."
                onkeydown="if(event && event.key === 'Enter' && !event.shiftKey) window.sendMessage();"
                autocomplete="off">
            <button id="sendBtn" onclick="window.sendMessage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // Configure marked for syntax highlighting
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true
        });

        // Conversation history for context
        let conversationHistory = [];
        
        // Load history from localStorage
        function loadHistory() {
            const saved = localStorage.getItem('maddybot_history');
            if (saved) {
                try {
                    conversationHistory = JSON.parse(saved);
                    // Restore chat UI
                    const chatlog = document.getElementById("chatlog");
                    if (conversationHistory.length > 0) {
                        chatlog.innerHTML = ''; // Clear welcome message
                        conversationHistory.forEach(msg => {
                            if (msg.role === 'user') {
                                addMessageToUI('user', msg.content);
                            } else if (msg.role === 'assistant') {
                                addMessageToUI('assistant', msg.content);
                            }
                        });
                    }
                } catch(e) {
                    conversationHistory = [];
                }
            }
        }
        
        // Save history to localStorage
        function saveHistory() {
            localStorage.setItem('maddybot_history', JSON.stringify(conversationHistory));
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTimestamp() {
            return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function addMessageToUI(role, content, timestamp = null) {
            const chatlog = document.getElementById("chatlog");
            const time = timestamp || getTimestamp();
            
            // Remove welcome message if present
            const welcome = chatlog.querySelector('.welcome-message');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' ? 'user' : 'Maddy';
            
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-content">${escapeHTML(content)}</div>
                    <span class="timestamp">${time}</span>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="bot-name">Maddy</span>
                    </div>
                    <div class="message-content">${marked.parse(content)}</div>
                    <span class="timestamp">${time}</span>
                `;
                // Add copy buttons to code blocks
                setTimeout(() => addCopyButtons(messageDiv), 0);
            }
            
            messageDiv.classList.add('fade-in');
            chatlog.appendChild(messageDiv);
            chatlog.scrollTop = chatlog.scrollHeight;
        }

        function addCopyButtons(container) {
            container.querySelectorAll('pre').forEach(pre => {
                if (pre.querySelector('.copy-btn')) return;
                
                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.innerHTML = 'ðŸ“‹ Copy';
                btn.onclick = async () => {
                    const code = pre.querySelector('code')?.textContent || pre.textContent;
                    await navigator.clipboard.writeText(code);
                    btn.innerHTML = 'âœ“ Copied!';
                    setTimeout(() => btn.innerHTML = 'ðŸ“‹ Copy', 2000);
                };
                pre.style.position = 'relative';
                pre.appendChild(btn);
            });
        }

        window.sendMessage = async function() {
            const input = document.getElementById("userinput");
            const sendBtn = document.getElementById("sendBtn");
            const message = input.value.trim();
            if (!message) return;

            const chatlog = document.getElementById("chatlog");
            
            // Disable input while processing
            input.disabled = true;
            sendBtn.disabled = true;

            // Show user message
            addMessageToUI('user', message);
            conversationHistory.push({ role: 'user', content: message });
            saveHistory();
            input.value = "";

            // Add typing indicator
            const typingDiv = document.createElement("div");
            typingDiv.className = "Maddy typing";
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
                <span class="typing-text">Maddy is thinking...</span>
            `;
            chatlog.appendChild(typingDiv);
            chatlog.scrollTop = chatlog.scrollHeight;

            try {
                const res = await fetch("/grok", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        prompt: message,
                        history: conversationHistory.slice(0, -1) // Send history without current message
                    })
                });
                const data = await res.json();

                // Remove typing indicator
                typingDiv.remove();

                // Show reply
                const replyText = data.reply || "No response";
                addMessageToUI('assistant', replyText, data.timestamp);
                conversationHistory.push({ role: 'assistant', content: replyText });
                saveHistory();

            } catch (err) {
                typingDiv.remove();
                addMessageToUI('assistant', `Sorry, I encountered an error: ${err.message}`);
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        function clearChat() {
            if (confirm('Clear all chat history?')) {
                conversationHistory = [];
                localStorage.removeItem('maddybot_history');
                const chatlog = document.getElementById("chatlog");
                chatlog.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-avatar">ðŸ‘‹</div>
                        <h2>Hi! I'm Maddy</h2>
                        <p>Your friendly AI assistant. Ask me anything!</p>
                    </div>
                `;
            }
        }

        // Handle mobile keyboard resize
        function handleResize() {
            const vh = window.innerHeight;
            document.documentElement.style.setProperty('--vh', vh + 'px');
            // Re-scroll to bottom when keyboard opens/closes
            const chatlog = document.getElementById('chatlog');
            if (chatlog) {
                setTimeout(() => { chatlog.scrollTop = chatlog.scrollHeight; }, 100);
            }
        }
        
        window.addEventListener('resize', handleResize);
        window.visualViewport?.addEventListener('resize', handleResize);
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            handleResize();
            loadHistory();
        });
    </script>
</body>
</html>
